# üáªüá≥ H∆∞·ªõng D·∫´n Tri·ªÉn Khai H·ªá Th·ªëng Monitoring - PROD-003

## üéØ T·ªïng Quan
H·ªá th·ªëng monitoring ho√†n ch·ªânh v·ªõi giao di·ªán ti·∫øng Vi·ªát, bao g·ªìm:
- **ELK Stack** (Elasticsearch, Logstash, Kibana, Filebeat)
- **Prometheus & Grafana** v·ªõi dashboard ti·∫øng Vi·ªát
- **AlertManager** v·ªõi th√¥ng b√°o ti·∫øng Vi·ªát
- **Business Intelligence Dashboards** cho Airbnb WebApp

## üìã Ki·∫øn Tr√∫c H·ªá Th·ªëng

### üèóÔ∏è Th√†nh Ph·∫ßn Ch√≠nh
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Airbnb App    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ   Prometheus    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    Grafana      ‚îÇ
‚îÇ   (Metrics)     ‚îÇ    ‚îÇ   (Collector)   ‚îÇ    ‚îÇ  (Dashboards)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚ñº                       ‚ñº                       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Filebeat     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    Logstash     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Elasticsearch   ‚îÇ
‚îÇ (Log Shipping)  ‚îÇ    ‚îÇ (Processing)    ‚îÇ    ‚îÇ  (Storage)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ                       ‚îÇ
                                ‚ñº                       ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ  AlertManager   ‚îÇ    ‚îÇ     Kibana      ‚îÇ
                     ‚îÇ (Notifications) ‚îÇ    ‚îÇ (Log Analysis)  ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Tri·ªÉn Khai

### 1Ô∏è‚É£ Kh·ªüi ƒê·ªông H·ªá Th·ªëng Monitoring
```powershell
# Di chuy·ªÉn ƒë·∫øn th∆∞ m·ª•c d·ª± √°n
cd d:\DUAN1\Airbnb\airbnb_webapp

# Kh·ªüi ƒë·ªông to√†n b·ªô h·ªá th·ªëng monitoring
docker-compose -f docker-compose.monitoring.yml up -d

# Ki·ªÉm tra tr·∫°ng th√°i
docker-compose -f docker-compose.monitoring.yml ps
```

### 2Ô∏è‚É£ X√°c Nh·∫≠n C√°c D·ªãch V·ª•
```powershell
# Ki·ªÉm tra logs
docker-compose -f docker-compose.monitoring.yml logs -f

# Ki·ªÉm tra health
curl http://localhost:9090/api/v1/query?query=up  # Prometheus
curl http://localhost:3000/api/health              # Grafana  
curl http://localhost:9200/_cluster/health         # Elasticsearch
curl http://localhost:5601/api/status              # Kibana
```

## üåê Truy C·∫≠p Giao Di·ªán Web

### üìä Grafana - Business Dashboards
- **URL**: http://localhost:3000
- **Login**: admin / admin123
- **Dashboards**:
  - üìà **Doanh Thu**: `/d/revenue-tracking` - Theo d√µi doanh thu theo th·ªùi gian th·ª±c
  - üéØ **Booking Performance**: `/d/booking-performance` - Ph√¢n t√≠ch hi·ªáu su·∫•t ƒë·∫∑t ph√≤ng
  - üè¢ **Property Utilization**: `/d/property-utilization` - S·ª≠ d·ª•ng b·∫•t ƒë·ªông s·∫£n
  - üí≥ **Payment Processing**: `/d/payment-processing` - X·ª≠ l√Ω thanh to√°n
  - ‚ö° **System Performance**: `/d/system-performance` - Hi·ªáu su·∫•t h·ªá th·ªëng

### üîç Kibana - Log Analysis
- **URL**: http://localhost:5601
- **Features**:
  - Index Patterns: `airbnb-logs-*`, `airbnb-errors-*`
  - Dashboards: Business logs, Error analysis
  - Visualizations: Vietnamese business metrics

### üìä Prometheus - Metrics
- **URL**: http://localhost:9090
- **Features**:
  - Metrics Explorer v·ªõi business metrics
  - Alert Rules v·ªõi m√¥ t·∫£ ti·∫øng Vi·ªát
  - Targets monitoring

### üö® AlertManager - Notifications
- **URL**: http://localhost:9093
- **Features**:
  - Vietnamese email templates
  - Business-context alerts
  - Escalation procedures

## üìä Dashboard Descriptions

### 1. üìà Revenue Tracking Dashboard
**M·ª•c ƒë√≠ch**: Theo d√µi doanh thu v√† hi·ªáu su·∫•t t√†i ch√≠nh

**Metrics ch√≠nh**:
- üí∞ Doanh thu h√¥m nay (VNƒê)
- üìä T·ª∑ l·ªá tƒÉng tr∆∞·ªüng doanh thu
- üè† Doanh thu theo b·∫•t ƒë·ªông s·∫£n  
- üìÖ Xu h∆∞·ªõng doanh thu 30 ng√†y
- üí≥ T·ª∑ l·ªá thanh to√°n th√†nh c√¥ng
- üìà Average Daily Rate (ADR)

**Filtering**: Theo lo·∫°i BƒêS, khu v·ª±c, th·ªùi gian

### 2. üéØ Booking Performance Dashboard  
**M·ª•c ƒë√≠ch**: Ph√¢n t√≠ch hi·ªáu su·∫•t ƒë·∫∑t ph√≤ng v√† h√†nh tr√¨nh kh√°ch h√†ng

**Metrics ch√≠nh**:
- üéØ T·ª∑ l·ªá ƒë·∫∑t ph√≤ng th√†nh c√¥ng
- üÜï Booking m·ªõi h√¥m nay
- ‚ùå T·ª∑ l·ªá h·ªßy booking
- üõí Ph·ªÖu chuy·ªÉn ƒë·ªïi kh√°ch h√†ng
- üè† Booking theo lo·∫°i BƒêS
- üìÖ Lead time trung b√¨nh
- üèÜ Top BƒêS c√≥ nhi·ªÅu booking
- ‚è∞ Xu h∆∞·ªõng booking theo gi·ªù

### 3. üè¢ Property Utilization Dashboard
**M·ª•c ƒë√≠ch**: Ph√¢n t√≠ch s·ª≠ d·ª•ng v√† hi·ªáu su·∫•t v·∫≠n h√†nh BƒêS

**Metrics ch√≠nh**:
- üè† T·ª∑ l·ªá s·ª≠ d·ª•ng trung b√¨nh
- ‚úÖ BƒêS ƒëang ho·∫°t ƒë·ªông
- ‚ö†Ô∏è BƒêS c·∫ßn b·∫£o tr√¨
- üìä T·ª∑ l·ªá s·ª≠ d·ª•ng theo BƒêS
- üí∞ Ph√¢n b·ªë doanh thu theo BƒêS
- üßπ Th·ªùi gian d·ªçn d·∫πp
- ‚≠ê ƒê√°nh gi√° kh√°ch h√†ng
- üí∏ Chi ph√≠ v·∫≠n h√†nh

### 4. üí≥ Payment Processing Dashboard
**M·ª•c ƒë√≠ch**: Gi√°m s√°t h·ªá th·ªëng thanh to√°n

**Metrics ch√≠nh**:
- üí≥ T·ª∑ l·ªá thanh to√°n th√†nh c√¥ng
- ‚è±Ô∏è Th·ªùi gian x·ª≠ l√Ω trung b√¨nh
- üí∞ T·ªïng gi√° tr·ªã giao d·ªãch
- üìà Xu h∆∞·ªõng giao d·ªãch
- üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n
- üåê Th·ªùi gian ph·∫£n h·ªìi gateway
- üö® Top l·ªói thanh to√°n
- üíµ Gi√° tr·ªã giao d·ªãch trung b√¨nh

### 5. ‚ö° System Performance Dashboard
**M·ª•c ƒë√≠ch**: Gi√°m s√°t hi·ªáu su·∫•t h·ªá th·ªëng

**Metrics ch√≠nh**:
- üñ•Ô∏è S·ª≠ d·ª•ng CPU
- üíæ S·ª≠ d·ª•ng RAM
- üåê Request/gi√¢y
- ‚è±Ô∏è Th·ªùi gian ph·∫£n h·ªìi
- üìä T√†i nguy√™n h·ªá th·ªëng
- üìà HTTP response codes
- üöÄ Response time theo endpoint
- üóÑÔ∏è K·∫øt n·ªëi database
- üêå Top endpoint ch·∫≠m nh·∫•t

## üö® Alert Rules

### üî• Critical Alerts
```yaml
# High Error Rate - T·ª∑ l·ªá l·ªói cao
- alert: TyLeLoi_Cao
  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
  for: 2m
  annotations:
    summary: "üö® T·ª∑ l·ªá l·ªói h·ªá th·ªëng cao"
    description: "T·ª∑ l·ªá l·ªói 5xx ƒë√£ v∆∞·ª£t qu√° 10% trong 2 ph√∫t"

# Database Down - C∆° s·ªü d·ªØ li·ªáu ng·ª´ng ho·∫°t ƒë·ªông  
- alert: CoSoDuLieu_NgungHoatDong
  expr: up{job="postgres"} == 0
  for: 1m
  annotations:
    summary: "üíÄ C∆° s·ªü d·ªØ li·ªáu ng·ª´ng ho·∫°t ƒë·ªông"
    description: "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu ch√≠nh"
```

### ‚ö†Ô∏è Warning Alerts
```yaml
# High CPU Usage - S·ª≠ d·ª•ng CPU cao
- alert: SuDung_CPU_Cao  
  expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
  for: 5m
  annotations:
    summary: "‚ö†Ô∏è S·ª≠ d·ª•ng CPU cao"
    description: "CPU s·ª≠ d·ª•ng > 80% trong 5 ph√∫t"

# Low Booking Success Rate - T·ª∑ l·ªá booking th√†nh c√¥ng th·∫•p
- alert: TyLeBooking_Thap
  expr: rate(airbnb_booking_success_total[1h]) / rate(airbnb_booking_attempts_total[1h]) < 0.8
  for: 10m
  annotations:
    summary: "üìâ T·ª∑ l·ªá booking th√†nh c√¥ng th·∫•p"
    description: "T·ª∑ l·ªá booking th√†nh c√¥ng < 80% trong 1 gi·ªù"
```

## üìß Email Notifications

### üé® Template Ti·∫øng Vi·ªát
```html
<h2>üö® C·∫£nh B√°o H·ªá Th·ªëng Airbnb WebApp</h2>
<p><strong>Th·ªùi gian:</strong> {{ .Alerts.CommonLabels.alertname }}</p>
<p><strong>M·ª©c ƒë·ªô:</strong> {{ .Alerts.CommonLabels.severity }}</p>
<p><strong>D·ªãch v·ª•:</strong> {{ .Alerts.CommonLabels.service }}</p>
<p><strong>M√¥ t·∫£:</strong> {{ .Alerts.CommonAnnotations.description }}</p>

<h3>üìã Chi Ti·∫øt C·∫£nh B√°o:</h3>
{{ range .Alerts }}
<ul>
  <li><strong>Metric:</strong> {{ .Labels.alertname }}</li>
  <li><strong>Instance:</strong> {{ .Labels.instance }}</li>
  <li><strong>Gi√° tr·ªã:</strong> {{ .Labels.value }}</li>
</ul>
{{ end }}

<p><em>H·ªá th·ªëng monitoring Airbnb WebApp - Vietnam</em></p>
```

## üîß C·∫•u H√¨nh N√¢ng Cao

### üìä Custom Business Metrics
```python
# Trong main.py ho·∫∑c payment_production.py
from prometheus_client import Counter, Histogram, Gauge

# Business metrics
revenue_total = Counter('airbnb_revenue_total', 'Total revenue in VND', ['property_id'])
booking_success = Counter('airbnb_booking_success_total', 'Successful bookings', ['property_type'])
payment_processing_time = Histogram('airbnb_payment_processing_duration_seconds', 'Payment processing time')
property_occupancy = Gauge('airbnb_property_occupancy_rate', 'Property occupancy rate', ['property_id'])

# Usage example
@app.post("/api/bookings")
async def create_booking(booking_data: BookingData):
    start_time = time.time()
    
    try:
        # Business logic here
        result = await process_booking(booking_data)
        
        # Record metrics
        booking_success.labels(property_type=booking_data.property_type).inc()
        revenue_total.labels(property_id=booking_data.property_id).inc(booking_data.amount)
        
        return result
    finally:
        payment_processing_time.observe(time.time() - start_time)
```

### üåç Timezone Configuration
```yaml
# grafana.ini
[defaults]
default_timezone = Asia/Ho_Chi_Minh

# Prometheus
global:
  evaluation_interval: 30s
  scrape_interval: 15s
  external_labels:
    timezone: 'Asia/Ho_Chi_Minh'
    region: 'Vietnam'
    environment: 'production'
```

## üõ†Ô∏è Troubleshooting

### ‚ùå Common Issues

#### 1. Grafana kh√¥ng hi·ªÉn th·ªã data
```powershell
# Ki·ªÉm tra Prometheus targets
curl http://localhost:9090/api/v1/targets

# Ki·ªÉm tra metrics
curl http://localhost:9090/api/v1/query?query=up

# Restart Grafana
docker-compose -f docker-compose.monitoring.yml restart grafana
```

#### 2. Elasticsearch kh√¥ng nh·∫≠n logs
```powershell
# Ki·ªÉm tra Filebeat
docker-compose -f docker-compose.monitoring.yml logs filebeat

# Ki·ªÉm tra Logstash pipeline
docker-compose -f docker-compose.monitoring.yml logs logstash

# Test Elasticsearch
curl -X GET "localhost:9200/_cat/indices?v"
```

#### 3. AlertManager kh√¥ng g·ª≠i email
```powershell
# Ki·ªÉm tra config
docker-compose -f docker-compose.monitoring.yml exec alertmanager \
  amtool config show

# Test email template
docker-compose -f docker-compose.monitoring.yml exec alertmanager \
  amtool template test-template.tmpl
```

### üîç Log Analysis Commands
```powershell
# Xem logs real-time
docker-compose -f docker-compose.monitoring.yml logs -f grafana
docker-compose -f docker-compose.monitoring.yml logs -f prometheus
docker-compose -f docker-compose.monitoring.yml logs -f elasticsearch

# Ki·ªÉm tra resource usage
docker stats

# Backup configuration
docker-compose -f docker-compose.monitoring.yml exec grafana \
  tar -czf /tmp/grafana-backup.tar.gz /var/lib/grafana
```

## üìà Performance Optimization

### üöÄ Elasticsearch
```yaml
# elk/elasticsearch/elasticsearch.yml
bootstrap.memory_lock: true
indices.memory.index_buffer_size: 20%
indices.memory.min_index_buffer_size: 96mb
thread_pool.write.queue_size: 1000
```

### üéØ Prometheus
```yaml
# monitoring/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 30s
  
rule_files:
  - "rules/*.yml"
  
scrape_configs:
  - job_name: 'airbnb-webapp'
    scrape_interval: 10s
    static_configs:
      - targets: ['airbnb-app:8000']
```

### üìä Grafana
```ini
# grafana/grafana.ini
[database]
type = postgres
host = postgres:5432
name = grafana
user = grafana
password = grafana123

[caching]
enabled = true
ttl = 300s
```

## üîí Security Best Practices

### üõ°Ô∏è Authentication
```yaml
# grafana/grafana.ini
[auth]
disable_login_form = false
disable_signout_menu = false

[auth.basic]
enabled = true

[security]
admin_user = admin
admin_password = $__file{/run/secrets/admin_password}
secret_key = $__file{/run/secrets/secret_key}
```

### üîê SSL/TLS
```yaml
# nginx/nginx.conf for production
server {
    listen 443 ssl http2;
    server_name monitoring.airbnb-webapp.vn;
    
    ssl_certificate /etc/ssl/certs/monitoring.crt;
    ssl_certificate_key /etc/ssl/private/monitoring.key;
    
    location /grafana/ {
        proxy_pass http://grafana:3000/;
    }
    
    location /prometheus/ {
        proxy_pass http://prometheus:9090/;
    }
}
```

## üìö T√†i Li·ªáu Tham Kh·∫£o

### üîó Links H·ªØu √çch
- [Grafana Documentation](https://grafana.com/docs/)
- [Prometheus Documentation](https://prometheus.io/docs/)
- [Elasticsearch Guide](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
- [AlertManager Configuration](https://prometheus.io/docs/alerting/latest/configuration/)

### üìñ Vietnamese Resources
- [H∆∞·ªõng d·∫´n Grafana ti·∫øng Vi·ªát](https://grafana.com/docs/grafana/latest/administration/internationalization/)
- [C·∫•u h√¨nh Prometheus cho ·ª©ng d·ª•ng Vi·ªát Nam](https://prometheus.io/docs/prometheus/latest/configuration/configuration/)

---

## ‚úÖ Checklist Tri·ªÉn Khai

- [ ] Docker containers kh·ªüi ƒë·ªông th√†nh c√¥ng
- [ ] Prometheus targets UP
- [ ] Grafana dashboards hi·ªÉn th·ªã data
- [ ] Elasticsearch nh·∫≠n logs
- [ ] Kibana index patterns created
- [ ] AlertManager rules configured
- [ ] Email notifications tested
- [ ] Vietnamese locale configured
- [ ] Business metrics tracking
- [ ] Performance optimized

**üéâ Ch√∫c m·ª´ng! H·ªá th·ªëng monitoring v·ªõi giao di·ªán ti·∫øng Vi·ªát ƒë√£ s·∫µn s√†ng cho production!**