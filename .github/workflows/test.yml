name: ğŸ§ª Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests with Server
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ’¾ Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ—„ï¸ Set up test database
      run: |
        echo "Setting up SQLite test database..."
        python -c "
        from db import create_database_engine, create_tables
        engine = create_database_engine()
        create_tables(engine)
        print('âœ… Test database created')
        "
        
    - name: ğŸš€ Start server in background
      run: |
        echo "Starting payment_production.py server..."
        python payment_production.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        echo "ğŸš€ Server started with PID: $SERVER_PID"
        
        # Wait for server to be ready
        echo "Waiting for server to start..."
        for i in {1..30}; do
          if curl -s http://localhost:8004/health > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "Attempt $i: Server not ready yet, waiting..."
          sleep 2
        done
        
        # Final health check
        if ! curl -s http://localhost:8004/health > /dev/null 2>&1; then
          echo "âŒ Server failed to start!"
          exit 1
        fi
        
    - name: ğŸ§ª Run tests
      run: |
        echo "Running pytest with server available..."
        pytest -v --tb=short
        
    - name: ğŸ›‘ Stop server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          echo "Stopping server (PID: $SERVER_PID)..."
          kill $SERVER_PID || true
          echo "âœ… Server stopped"
        fi
        
    - name: ğŸ“Š Test Results Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ§ª TEST EXECUTION COMPLETE"
        echo "Server was running during tests on port 8004"
        echo "All integration tests should have passed with live server"