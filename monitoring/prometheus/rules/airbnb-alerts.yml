# =====================================================
# AIRBNB WEBAPP - ALERT RULES
# Vietnamese Business Metrics v√† Infrastructure Alerts
# =====================================================

groups:
  # ===================================================
  # INFRASTRUCTURE ALERTS - Critical System Issues
  # ===================================================
  
  - name: infrastructure.alerts
    interval: 30s
    rules:
      # Database Connectivity - CRITICAL
      - alert: DatabaseDown
        expr: up{job="postgres"} == 0
        for: 30s
        labels:
          severity: critical
          service: database
          category: infrastructure
          team: devops
        annotations:
          summary: "üî¥ C∆° s·ªü d·ªØ li·ªáu Airbnb kh√¥ng kh·∫£ d·ª•ng"
          description: "Database PostgreSQL ƒë√£ down trong {{ $value }} gi√¢y. H·ªá th·ªëng booking v√† payment s·∫Ω b·ªã ·∫£nh h∆∞·ªüng nghi√™m tr·ªçng."
          impact: "Kh√°ch h√†ng kh√¥ng th·ªÉ ƒë·∫∑t ph√≤ng, thanh to√°n b·ªã gi√°n ƒëo·∫°n"
          action: "Ki·ªÉm tra ngay container postgres v√† disk space"
          dashboard: "http://localhost:3000/d/postgres"
          runbook: "https://wiki.company.com/database-outage"
          
      # Application Health - CRITICAL  
      - alert: WebAppDown
        expr: up{job="airbnb-webapp"} == 0
        for: 1m
        labels:
          severity: critical
          service: application
          category: infrastructure
          team: backend
        annotations:
          summary: "üî¥ ·ª®ng d·ª•ng Airbnb kh√¥ng ph·∫£n h·ªìi"
          description: "FastAPI application ƒë√£ kh√¥ng ph·∫£n h·ªìi trong {{ $value }} ph√∫t"
          impact: "To√†n b·ªô h·ªá th·ªëng Airbnb kh√¥ng kh·∫£ d·ª•ng cho kh√°ch h√†ng"
          action: "Restart container webapp v√† ki·ªÉm tra logs"
          logs: "docker logs airbnb_webapp --tail 100"
          
      # High Memory Usage - WARNING
      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
        for: 5m
        labels:
          severity: warning
          service: system
          category: performance
          team: devops
        annotations:
          summary: "‚ö†Ô∏è M·ª©c s·ª≠ d·ª•ng memory cao ({{ $value | humanizePercentage }})"
          description: "Server ƒëang s·ª≠ d·ª•ng h∆°n 85% memory trong 5 ph√∫t qua"
          current_usage: "{{ $value | humanizePercentage }}"
          threshold: "85%"
          action: "Ki·ªÉm tra processes ƒëang ti√™u th·ª• memory nhi·ªÅu nh·∫•t"
          
      # High CPU Usage - WARNING
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 10m
        labels:
          severity: warning
          service: system
          category: performance
          team: devops
        annotations:
          summary: "‚ö†Ô∏è M·ª©c s·ª≠ d·ª•ng CPU cao ({{ $value | printf \"%.1f\" }}%)"
          description: "CPU usage ƒë√£ v∆∞·ª£t 80% trong 10 ph√∫t li√™n t·ª•c"
          current_usage: "{{ $value | printf \"%.1f\" }}%"
          threshold: "80%"
          
      # Disk Space Low - WARNING
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.2
        for: 5m
        labels:
          severity: warning
          service: system
          category: storage
          team: devops
        annotations:
          summary: "‚ö†Ô∏è Dung l∆∞·ª£ng disk th·∫•p (c√≤n {{ $value | humanizePercentage }})"
          description: "Disk space c√≤n l·∫°i d∆∞·ªõi 20% c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn ho·∫°t ƒë·ªông h·ªá th·ªëng"
          available_space: "{{ $value | humanizePercentage }}"
          action: "D·ªçn d·∫πp logs v√† temporary files"
          
      # Redis Cache Down - WARNING
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: warning
          service: cache
          category: infrastructure
          team: backend
        annotations:
          summary: "‚ö†Ô∏è Redis cache kh√¥ng kh·∫£ d·ª•ng"
          description: "Redis ƒë√£ down trong {{ $value }} ph√∫t. Session v√† caching b·ªã ·∫£nh h∆∞·ªüng"
          impact: "Hi·ªáu su·∫•t h·ªá th·ªëng gi·∫£m, users c√≥ th·ªÉ b·ªã logout"
          action: "Restart Redis container"

  # ===================================================
  # BUSINESS METRICS ALERTS - Vietnamese KPIs
  # ===================================================
  
  - name: business.metrics
    interval: 60s
    rules:
      # Booking Success Rate Drop - WARNING
      - alert: BookingSuccessRateDrop
        expr: (rate(airbnb_booking_success_total[1h]) / rate(airbnb_booking_attempts_total[1h])) < 0.9
        for: 10m
        labels:
          severity: warning
          service: booking
          category: business
          team: business
        annotations:
          summary: "üìâ T·ª∑ l·ªá ƒë·∫∑t ph√≤ng th√†nh c√¥ng gi·∫£m ({{ $value | humanizePercentage }})"
          description: "T·ª∑ l·ªá booking th√†nh c√¥ng ƒë√£ gi·∫£m xu·ªëng d∆∞·ªõi 90% trong 10 ph√∫t qua"
          current_rate: "{{ $value | humanizePercentage }}"
          expected_rate: "> 90%"
          impact: "Kh√°ch h√†ng g·∫∑p kh√≥ khƒÉn khi ƒë·∫∑t ph√≤ng, c√≥ th·ªÉ m·∫•t doanh thu"
          action: "Ki·ªÉm tra API booking v√† payment flow"
          dashboard: "http://localhost:3000/d/bookings"
          
      # High Booking Cancellation Rate - WARNING  
      - alert: HighCancellationRate
        expr: (rate(airbnb_booking_cancelled_total[24h]) / rate(airbnb_booking_success_total[24h])) > 0.15
        for: 30m
        labels:
          severity: warning
          service: booking
          category: business
          team: business
        annotations:
          summary: "üìâ T·ª∑ l·ªá h·ªßy ph√≤ng cao ({{ $value | humanizePercentage }})"
          description: "T·ª∑ l·ªá h·ªßy booking trong 24h qua ƒë√£ v∆∞·ª£t 15%"
          current_rate: "{{ $value | humanizePercentage }}"
          threshold: "< 15%"
          impact: "·∫¢nh h∆∞·ªüng ƒë·∫øn doanh thu v√† hi·ªáu qu·∫£ kinh doanh"
          action: "Ph√¢n t√≠ch l√Ω do h·ªßy v√† c·∫£i thi·ªán quy tr√¨nh"
          
      # Payment Failure Rate High - CRITICAL
      - alert: PaymentFailureRateHigh
        expr: (rate(airbnb_payment_failed_total[1h]) / rate(airbnb_payment_attempts_total[1h])) > 0.05
        for: 5m
        labels:
          severity: critical
          service: payment
          category: business
          team: payment
        annotations:
          summary: "üî¥ T·ª∑ l·ªá thanh to√°n th·∫•t b·∫°i cao ({{ $value | humanizePercentage }})"
          description: "H∆°n 5% giao d·ªãch thanh to√°n th·∫•t b·∫°i trong 1 gi·ªù qua"
          current_rate: "{{ $value | humanizePercentage }}"
          threshold: "< 5%"
          impact: "M·∫•t doanh thu tr·ª±c ti·∫øp, kh√°ch h√†ng kh√¥ng ho√†n th√†nh booking"
          action: "Ki·ªÉm tra payment gateway v√† banking API ngay l·∫≠p t·ª©c"
          
      # Low Daily Revenue - WARNING
      - alert: LowDailyRevenue
        expr: increase(airbnb_revenue_vnd_total[24h]) < 50000000  # < 50M VND per day
        for: 2h
        labels:
          severity: warning
          service: revenue
          category: business
          team: business
        annotations:
          summary: "üìâ Doanh thu h√†ng ng√†y th·∫•p ({{ $value | printf \"%.0f\" }} VND)"
          description: "Doanh thu trong 24h qua d∆∞·ªõi 50 tri·ªáu VND"
          current_revenue: "{{ $value | printf \"%.0f\" }} VND"
          expected_revenue: "> 50,000,000 VND"
          impact: "Kh√¥ng ƒë·∫°t target doanh thu h√†ng ng√†y"
          action: "Ki·ªÉm tra marketing campaigns v√† pricing strategy"
          
      # Response Time High - WARNING
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(airbnb_request_duration_seconds_bucket[5m])) > 2
        for: 10m
        labels:
          severity: warning
          service: performance
          category: performance
          team: backend
        annotations:
          summary: "‚ö†Ô∏è Th·ªùi gian ph·∫£n h·ªìi cao ({{ $value | printf \"%.2f\" }}s)"
          description: "95% requests m·∫•t h∆°n 2 gi√¢y ƒë·ªÉ ho√†n th√†nh"
          current_p95: "{{ $value | printf \"%.2f\" }}s"
          threshold: "< 2s"
          impact: "Tr·∫£i nghi·ªám ng∆∞·ªùi d√πng k√©m, c√≥ th·ªÉ m·∫•t kh√°ch h√†ng"
          action: "Optimize database queries v√† application performance"

  # ===================================================
  # SECURITY ALERTS - Vietnamese Security Monitoring
  # ===================================================
  
  - name: security.alerts
    interval: 60s
    rules:
      # High Failed Login Rate - WARNING
      - alert: HighFailedLoginRate
        expr: rate(airbnb_failed_logins_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: authentication
          category: security
          team: security
        annotations:
          summary: "üõ°Ô∏è T·ª∑ l·ªá ƒëƒÉng nh·∫≠p th·∫•t b·∫°i cao ({{ $value | printf \"%.1f\" }}/ph√∫t)"
          description: "H∆°n 10 l·∫ßn ƒëƒÉng nh·∫≠p th·∫•t b·∫°i m·ªói ph√∫t trong 2 ph√∫t qua"
          current_rate: "{{ $value | printf \"%.1f\" }} failures/minute"
          threshold: "< 10/minute"
          threat_level: "C√≥ th·ªÉ b·ªã brute force attack"
          action: "Ki·ªÉm tra source IPs v√† implement rate limiting"
          
      # Suspicious API Usage - WARNING
      - alert: SuspiciousAPIUsage
        expr: rate(airbnb_api_requests_total{status_code=~"4.*"}[10m]) > 50
        for: 5m
        labels:
          severity: warning
          service: api
          category: security
          team: security
        annotations:
          summary: "üõ°Ô∏è Ho·∫°t ƒë·ªông API ƒë√°ng ng·ªù ({{ $value | printf \"%.1f\" }} 4xx/ph√∫t)"
          description: "Nhi·ªÅu requests b·ªã t·ª´ ch·ªëi (4xx errors) c√≥ th·ªÉ l√† t·∫•n c√¥ng"
          error_rate: "{{ $value | printf \"%.1f\" }} 4xx/minute"
          action: "Ph√¢n t√≠ch access logs ƒë·ªÉ x√°c ƒë·ªãnh source"
          dashboard: "http://localhost:3000/d/security"

  # ===================================================
  # APPLICATION HEALTH ALERTS
  # ===================================================
  
  - name: application.health
    interval: 30s
    rules:
      # Database Connection Pool Exhausted - CRITICAL
      - alert: DatabaseConnectionPoolExhausted
        expr: airbnb_db_connections_active / airbnb_db_connections_max > 0.9
        for: 1m
        labels:
          severity: critical
          service: database
          category: performance
          team: backend
        annotations:
          summary: "üî¥ Database connection pool g·∫ßn h·∫øt ({{ $value | humanizePercentage }})"
          description: "S·ª≠ d·ª•ng h∆°n 90% connection pool c√≥ th·ªÉ g√¢y database timeout"
          usage: "{{ $value | humanizePercentage }}"
          action: "TƒÉng pool size ho·∫∑c optimize database queries"
          
      # Slow Database Queries - WARNING
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(airbnb_db_query_duration_seconds_bucket[5m])) > 1
        for: 10m
        labels:
          severity: warning
          service: database
          category: performance
          team: backend
        annotations:
          summary: "‚ö†Ô∏è Database queries ch·∫≠m ({{ $value | printf \"%.2f\" }}s)"
          description: "95% queries m·∫•t h∆°n 1 gi√¢y ƒë·ªÉ ho√†n th√†nh"
          p95_duration: "{{ $value | printf \"%.2f\" }}s"
          action: "Ki·ªÉm tra slow query log v√† optimize indexes"