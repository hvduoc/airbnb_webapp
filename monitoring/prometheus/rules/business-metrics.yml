# =====================================================
# BUSINESS METRICS ALERT RULES
# Vietnamese Business KPIs cho Airbnb WebApp
# =====================================================

groups:
  # ===================================================
  # REVENUE & FINANCIAL METRICS
  # ===================================================
  
  - name: revenue.metrics
    interval: 300s  # 5 minutes
    rules:
      # Daily Revenue Tracking
      - record: airbnb:revenue_daily_vnd
        expr: increase(airbnb_revenue_vnd_total[24h])
        labels:
          period: "daily"
          currency: "VND"
          
      - record: airbnb:revenue_hourly_vnd
        expr: increase(airbnb_revenue_vnd_total[1h])
        labels:
          period: "hourly" 
          currency: "VND"
          
      # Average Revenue Per Booking
      - record: airbnb:avg_revenue_per_booking
        expr: |
          (
            increase(airbnb_revenue_vnd_total[24h]) / 
            increase(airbnb_booking_success_total[24h])
          )
        labels:
          metric_type: "financial_kpi"
          period: "daily"
          
      # Revenue Growth Rate (so v·ªõi tu·∫ßn tr∆∞·ªõc)
      - record: airbnb:revenue_growth_rate
        expr: |
          (
            (increase(airbnb_revenue_vnd_total[7d]) - increase(airbnb_revenue_vnd_total[7d] offset 7d)) /
            increase(airbnb_revenue_vnd_total[7d] offset 7d)
          ) * 100
        labels:
          metric_type: "growth_rate"
          period: "weekly"

      # Revenue Alerts
      - alert: DailyRevenueTarget
        expr: airbnb:revenue_daily_vnd < 50000000  # < 50M VND
        for: 4h
        labels:
          severity: warning
          category: business
          metric_type: "revenue"
          team: "business"
        annotations:
          summary: "üìâ Doanh thu h√†ng ng√†y d∆∞·ªõi m·ª•c ti√™u"
          description: "Doanh thu h√¥m nay: {{ $value | printf \"%.0f\" }} VND (M·ª•c ti√™u: 50M VND)"
          target: "50,000,000 VND"
          current: "{{ $value | printf \"%.0f\" }} VND"
          shortfall: "{{ sub 50000000 $value | printf \"%.0f\" }} VND"
          action: "Review pricing v√† marketing campaigns"
          
      - alert: WeeklyRevenueDecline
        expr: airbnb:revenue_growth_rate < -10  # Gi·∫£m > 10%
        for: 1h
        labels:
          severity: warning
          category: business
          metric_type: "revenue"
          team: "business"
        annotations:
          summary: "üìâ Doanh thu tu·∫ßn n√†y gi·∫£m {{ $value | printf \"%.1f\" }}%"
          description: "Doanh thu tu·∫ßn n√†y gi·∫£m h∆°n 10% so v·ªõi tu·∫ßn tr∆∞·ªõc"
          decline_rate: "{{ $value | printf \"%.1f\" }}%"
          action: "Ph√¢n t√≠ch nguy√™n nh√¢n v√† ƒëi·ªÅu ch·ªânh strategy"

  # ===================================================
  # BOOKING PERFORMANCE METRICS
  # ===================================================
  
  - name: booking.metrics
    interval: 60s
    rules:
      # Booking Success Rate
      - record: airbnb:booking_success_rate
        expr: |
          (
            rate(airbnb_booking_success_total[1h]) / 
            rate(airbnb_booking_attempts_total[1h])
          ) * 100
        labels:
          metric_type: "conversion_rate"
          
      # Booking Cancellation Rate
      - record: airbnb:booking_cancellation_rate
        expr: |
          (
            rate(airbnb_booking_cancelled_total[24h]) / 
            rate(airbnb_booking_success_total[24h])
          ) * 100
        labels:
          metric_type: "cancellation_rate"
          
      # Average Booking Value (VND)
      - record: airbnb:avg_booking_value
        expr: |
          (
            increase(airbnb_revenue_vnd_total[1h]) / 
            increase(airbnb_booking_success_total[1h])
          )
        labels:
          metric_type: "avg_order_value"
          currency: "VND"
          
      # Bookings per Hour
      - record: airbnb:bookings_per_hour
        expr: rate(airbnb_booking_success_total[1h]) * 3600
        labels:
          metric_type: "booking_velocity"
          
      # Daily New Bookings
      - record: airbnb:daily_new_bookings
        expr: increase(airbnb_booking_success_total[24h])
        labels:
          metric_type: "daily_bookings"

      # Booking Alerts
      - alert: LowBookingSuccessRate
        expr: airbnb:booking_success_rate < 85
        for: 30m
        labels:
          severity: warning
          category: business
          service: booking
          team: "product"
        annotations:
          summary: "üìâ T·ª∑ l·ªá ƒë·∫∑t ph√≤ng th√†nh c√¥ng th·∫•p ({{ $value | printf \"%.1f\" }}%)"
          description: "Ch·ªâ {{ $value | printf \"%.1f\" }}% booking attempts th√†nh c√¥ng trong 30 ph√∫t qua"
          target: "‚â• 85%"
          current: "{{ $value | printf \"%.1f\" }}%"
          impact: "Kh√°ch h√†ng g·∫∑p kh√≥ khƒÉn khi ƒë·∫∑t ph√≤ng"
          action: "Ki·ªÉm tra booking flow v√† payment gateway"
          
      - alert: HighCancellationRate
        expr: airbnb:booking_cancellation_rate > 20
        for: 2h
        labels:
          severity: warning
          category: business
          service: booking
          team: "customer_success"
        annotations:
          summary: "üìâ T·ª∑ l·ªá h·ªßy ph√≤ng cao ({{ $value | printf \"%.1f\" }}%)"
          description: "{{ $value | printf \"%.1f\" }}% bookings b·ªã h·ªßy trong 2 gi·ªù qua"
          threshold: "< 20%"
          current: "{{ $value | printf \"%.1f\" }}%"
          action: "Ph√¢n t√≠ch l√Ω do h·ªßy v√† c·∫£i thi·ªán customer experience"
          
      - alert: LowDailyBookings
        expr: airbnb:daily_new_bookings < 20  # < 20 bookings/day
        for: 6h
        labels:
          severity: warning
          category: business
          service: booking
          team: "marketing"
        annotations:
          summary: "üìâ S·ªë l∆∞·ª£ng booking h√†ng ng√†y th·∫•p ({{ $value | printf \"%.0f\" }})"
          description: "Ch·ªâ c√≥ {{ $value | printf \"%.0f\" }} bookings trong 24h qua"
          target: "‚â• 20 bookings/day"
          current: "{{ $value | printf \"%.0f\" }} bookings"
          action: "TƒÉng c∆∞·ªùng marketing v√† promotion campaigns"

  # ===================================================
  # PAYMENT PERFORMANCE METRICS
  # ===================================================
  
  - name: payment.metrics
    interval: 60s
    rules:
      # Payment Success Rate
      - record: airbnb:payment_success_rate
        expr: |
          (
            rate(airbnb_payment_success_total[1h]) / 
            rate(airbnb_payment_attempts_total[1h])
          ) * 100
        labels:
          metric_type: "payment_conversion"
          
      # Payment Failure Rate by Type
      - record: airbnb:payment_failure_rate
        expr: |
          (
            rate(airbnb_payment_failed_total[1h]) / 
            rate(airbnb_payment_attempts_total[1h])
          ) * 100
        labels:
          metric_type: "payment_failure"
          
      # Average Payment Processing Time
      - record: airbnb:avg_payment_duration
        expr: histogram_quantile(0.5, rate(airbnb_payment_duration_seconds_bucket[5m]))
        labels:
          metric_type: "payment_performance"
          quantile: "p50"
          
      - record: airbnb:p95_payment_duration
        expr: histogram_quantile(0.95, rate(airbnb_payment_duration_seconds_bucket[5m]))
        labels:
          metric_type: "payment_performance"
          quantile: "p95"

      # Payment Alerts
      - alert: PaymentSuccessRateLow
        expr: airbnb:payment_success_rate < 95
        for: 10m
        labels:
          severity: critical
          category: business
          service: payment
          team: "payment"
        annotations:
          summary: "üî¥ T·ª∑ l·ªá thanh to√°n th√†nh c√¥ng th·∫•p ({{ $value | printf \"%.1f\" }}%)"
          description: "Ch·ªâ {{ $value | printf \"%.1f\" }}% payments th√†nh c√¥ng trong 10 ph√∫t qua"
          target: "‚â• 95%"
          current: "{{ $value | printf \"%.1f\" }}%"
          impact: "M·∫•t doanh thu tr·ª±c ti·∫øp, kh√°ch h√†ng kh√¥ng th·ªÉ ho√†n th√†nh booking"
          action: "Ki·ªÉm tra payment gateway v√† banking API ngay l·∫≠p t·ª©c"
          
      - alert: SlowPaymentProcessing
        expr: airbnb:p95_payment_duration > 10
        for: 15m
        labels:
          severity: warning
          category: performance
          service: payment
          team: "payment"
        annotations:
          summary: "‚ö†Ô∏è Thanh to√°n x·ª≠ l√Ω ch·∫≠m (P95: {{ $value | printf \"%.1f\" }}s)"
          description: "95% payments m·∫•t h∆°n 10 gi√¢y ƒë·ªÉ ho√†n th√†nh"
          threshold: "< 10s"
          current: "{{ $value | printf \"%.1f\" }}s"
          impact: "Kh√°ch h√†ng c√≥ th·ªÉ b·ªè cu·ªôc trong qu√° tr√¨nh thanh to√°n"
          action: "Optimize payment flow v√† check banking API performance"

  # ===================================================
  # PROPERTY UTILIZATION METRICS
  # ===================================================
  
  - name: property.metrics
    interval: 300s
    rules:
      # Property Occupancy Rate
      - record: airbnb:property_occupancy_rate
        expr: |
          (
            sum(airbnb_property_booked_nights_total) / 
            sum(airbnb_property_available_nights_total)
          ) * 100
        labels:
          metric_type: "occupancy_rate"
          
      # Average Daily Rate (ADR)
      - record: airbnb:average_daily_rate
        expr: |
          (
            increase(airbnb_revenue_vnd_total[24h]) / 
            sum(increase(airbnb_property_booked_nights_total[24h]))
          )
        labels:
          metric_type: "adr"
          currency: "VND"
          
      # Revenue Per Available Room (RevPAR)
      - record: airbnb:revpar
        expr: |
          (
            increase(airbnb_revenue_vnd_total[24h]) / 
            sum(airbnb_property_available_nights_total)
          )
        labels:
          metric_type: "revpar"
          currency: "VND"

      # Property Performance Alerts
      - alert: LowOccupancyRate
        expr: airbnb:property_occupancy_rate < 60
        for: 24h
        labels:
          severity: warning
          category: business
          service: property
          team: "revenue_management"
        annotations:
          summary: "üìâ T·ª∑ l·ªá l·∫•p ƒë·∫ßy ph√≤ng th·∫•p ({{ $value | printf \"%.1f\" }}%)"
          description: "Occupancy rate ch·ªâ {{ $value | printf \"%.1f\" }}% trong 24h qua"
          target: "‚â• 60%"
          current: "{{ $value | printf \"%.1f\" }}%"
          action: "ƒêi·ªÅu ch·ªânh pricing strategy v√† tƒÉng c∆∞·ªùng marketing"
          
      - alert: DecreasingADR
        expr: |
          (
            (airbnb:average_daily_rate - airbnb:average_daily_rate offset 7d) / 
            airbnb:average_daily_rate offset 7d
          ) * 100 < -15
        for: 2h
        labels:
          severity: warning
          category: business
          service: property
          team: "revenue_management"
        annotations:
          summary: "üìâ ADR gi·∫£m h∆°n 15% so v·ªõi tu·∫ßn tr∆∞·ªõc"
          description: "Average Daily Rate ƒëang gi·∫£m ƒë√°ng k·ªÉ"
          action: "Review pricing strategy v√† competitor analysis"

  # ===================================================
  # CUSTOMER EXPERIENCE METRICS
  # ===================================================
  
  - name: customer.metrics
    interval: 300s
    rules:
      # Response Time SLA
      - record: airbnb:api_response_time_p95
        expr: histogram_quantile(0.95, rate(airbnb_request_duration_seconds_bucket[5m]))
        labels:
          metric_type: "response_time"
          sla_level: "p95"
          
      # Error Rate
      - record: airbnb:api_error_rate
        expr: |
          (
            rate(airbnb_http_requests_total{status_code=~"5.*"}[5m]) / 
            rate(airbnb_http_requests_total[5m])
          ) * 100
        labels:
          metric_type: "error_rate"

      # Customer Experience Alerts
      - alert: HighAPIResponseTime
        expr: airbnb:api_response_time_p95 > 3
        for: 10m
        labels:
          severity: warning
          category: performance
          service: api
          team: "backend"
        annotations:
          summary: "‚ö†Ô∏è API response time cao (P95: {{ $value | printf \"%.2f\" }}s)"
          description: "95% API requests m·∫•t h∆°n 3 gi√¢y ƒë·ªÉ ph·∫£n h·ªìi"
          threshold: "< 3s"
          current: "{{ $value | printf \"%.2f\" }}s"
          impact: "Tr·∫£i nghi·ªám ng∆∞·ªùi d√πng k√©m, c√≥ th·ªÉ m·∫•t conversion"
          action: "Optimize API performance v√† database queries"
          
      - alert: HighAPIErrorRate
        expr: airbnb:api_error_rate > 2
        for: 5m
        labels:
          severity: critical
          category: reliability
          service: api
          team: "backend"
        annotations:
          summary: "üî¥ T·ª∑ l·ªá l·ªói API cao ({{ $value | printf \"%.2f\" }}%)"
          description: "{{ $value | printf \"%.2f\" }}% API requests tr·∫£ v·ªÅ 5xx errors"
          threshold: "< 2%"
          current: "{{ $value | printf \"%.2f\" }}%"
          impact: "Kh√°ch h√†ng g·∫∑p l·ªói khi s·ª≠ d·ª•ng h·ªá th·ªëng"
          action: "Ki·ªÉm tra application logs v√† fix bugs ngay l·∫≠p t·ª©c"