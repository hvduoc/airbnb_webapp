{% extends "layout.html" %}
{% block content %}
<h1>üè† Qu·∫£n l√Ω ph√¢n b·ªï ph√≤ng</h1>
<p class="muted">
  <a href="/bookings/{{ booking.id }}">‚Üê Quay l·∫°i booking {{ booking.confirmation_code }}</a>
</p>

<!-- Booking Context -->
<div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
  <h3 style="margin: 0 0 8px 0;">üìã Booking Context</h3>
  <p style="margin: 0;"><strong>{{ booking.guest_name }}</strong> ‚Ä¢ {{ booking.start_date }} - {{ booking.end_date }} ‚Ä¢
    {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</p>
  <p style="margin: 4px 0 0 0; color: #6c757d;">{{ booking.listing_raw or booking.property_short }}</p>
</div>

<!-- Room Assignment Form -->
<form method="post" action="/bookings/{{ booking.id }}/room-assignment" style="max-width: 600px;">

  <h2>üè† Th√¥ng tin ph√≤ng</h2>

  <label>Ph√≤ng ƒë√£ ƒë·∫∑t (t·ª´ booking)
    <select name="booked_room" required>
      <option value="">-- Ch·ªçn ph√≤ng ƒë√£ ƒë·∫∑t --</option>
      {% for prop in properties %}
      <option value="{{ prop.property_short or prop.property_name }}" {{ 'selected' if room_assignment and
        room_assignment.booked_room==(prop.property_short or prop.property_name) else '' }}>
        {{ prop.property_short or prop.property_name }}
        {% if prop.airbnb_name and prop.airbnb_name != (prop.property_short or prop.property_name) %}
        - {{ prop.airbnb_name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
    <small>Ph√≤ng ƒë∆∞·ª£c kh√°ch book ban ƒë·∫ßu trong reservation</small>
  </label>

  <label>Ph√≤ng th·ª±c t·∫ø (kh√°ch ·ªü th·∫≠t)
    <select name="actual_room" required>
      <option value="">-- Ch·ªçn ph√≤ng th·ª±c t·∫ø --</option>
      {% for prop in properties %}
      <option value="{{ prop.property_short or prop.property_name }}" {{ 'selected' if room_assignment and
        room_assignment.actual_room==(prop.property_short or prop.property_name) else '' }}>
        {{ prop.property_short or prop.property_name }}
        {% if prop.airbnb_name and prop.airbnb_name != (prop.property_short or prop.property_name) %}
        - {{ prop.airbnb_name }}
        {% endif %}
      </option>
      {% endfor %}
    </select>
    <small>Ph√≤ng th·ª±c t·∫ø kh√°ch check-in v√† ·ªü</small>
  </label>

  <!-- Revenue Attribution -->
  <h2 style="margin-top: 32px;">üí∞ Ph√¢n b·ªï doanh thu</h2>

  <label>Doanh thu t√≠nh cho ph√≤ng n√†o?
    <select name="revenue_attribution" required>
      <option value="actual_room" {{ 'selected' if (room_assignment and
        room_assignment.revenue_attribution=='actual_room' ) or not room_assignment else '' }}>
        üè† Ph√≤ng th·ª±c t·∫ø (khuy·∫øn ngh·ªã)
      </option>
      <option value="booked_room" {{ 'selected' if room_assignment and
        room_assignment.revenue_attribution=='booked_room' else '' }}>
        üìç Ph√≤ng ƒë√£ ƒë·∫∑t
      </option>
      <option value="split" {{ 'selected' if room_assignment and room_assignment.revenue_attribution=='split' else ''
        }}>
        ‚öñÔ∏è Chia ƒë√¥i
      </option>
    </select>
    <small>Quy t·∫Øc ph√¢n b·ªï {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</small>
  </label>

  <!-- Change Details -->
  <h2 style="margin-top: 32px;">üìù Chi ti·∫øt thay ƒë·ªïi</h2>

  <label>L√Ω do ƒë·ªïi ph√≤ng
    <select name="change_reason" required>
      <option value="" {{ 'selected' if not room_assignment or not room_assignment.change_reason else '' }}>-- Ch·ªçn l√Ω
        do --</option>
      <option value="maintenance" {{ 'selected' if room_assignment and room_assignment.change_reason=='maintenance'
        else '' }}>
        üîß B·∫£o tr√¨ ph√≤ng ƒë√£ ƒë·∫∑t
      </option>
      <option value="guest_request" {{ 'selected' if room_assignment and room_assignment.change_reason=='guest_request'
        else '' }}>
        üë§ Y√™u c·∫ßu c·ªßa kh√°ch
      </option>
      <option value="upgrade" {{ 'selected' if room_assignment and room_assignment.change_reason=='upgrade' else '' }}>
        ‚¨ÜÔ∏è Upgrade ph√≤ng
      </option>
      <option value="overbooking" {{ 'selected' if room_assignment and room_assignment.change_reason=='overbooking'
        else '' }}>
        üìÖ Overbooking/xung ƒë·ªôt l·ªãch
      </option>
      <option value="operational" {{ 'selected' if room_assignment and room_assignment.change_reason=='operational'
        else '' }}>
        ‚öôÔ∏è L√Ω do v·∫≠n h√†nh
      </option>
      <option value="other" {{ 'selected' if room_assignment and room_assignment.change_reason=='other' else '' }}>
        üìã Kh√°c
      </option>
    </select>
  </label>

  <label>Ng√†y thay ƒë·ªïi
    <input type="date" name="changed_date"
      value="{{ room_assignment.changed_date if room_assignment and room_assignment.changed_date else booking.start_date }}">
    <small>Ng√†y x√°c nh·∫≠n/th·ª±c hi·ªán vi·ªác ƒë·ªïi ph√≤ng</small>
  </label>

  <label>Ng∆∞·ªùi th·ª±c hi·ªán
    <input type="text" name="changed_by" value="{{ room_assignment.changed_by if room_assignment else '' }}"
      placeholder="T√™n nh√¢n vi√™n">
    <small>Ai l√† ng∆∞·ªùi x·ª≠ l√Ω vi·ªác ƒë·ªïi ph√≤ng</small>
  </label>

  <label>Ghi ch√∫
    <textarea name="notes" rows="3"
      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ vi·ªác ƒë·ªïi ph√≤ng...">{{ room_assignment.notes if room_assignment else '' }}</textarea>
  </label>

  <!-- Submit -->
  <div style="margin-top: 32px; padding-top: 16px; border-top: 1px solid #dee2e6;">
    <button type="submit" class="btn" style="margin-right: 8px;">
      {{ 'üíæ C·∫≠p nh·∫≠t' if room_assignment else '‚ûï T·∫°o m·ªõi' }} Room Assignment
    </button>
    <a href="/bookings/{{ booking.id }}" class="btn" style="background: #6c757d;">‚ùå H·ªßy</a>
  </div>

</form>

<!-- Room Assignment Preview -->
{% if room_assignment %}
<div style="margin-top: 32px; background: #e3f2fd; padding: 16px; border-radius: 8px;">
  <h3>üîç Preview ph√¢n b·ªï doanh thu</h3>
  <div id="revenue-preview">
    <!-- Will be populated by JavaScript or server-side -->
    <p><strong>T·ªïng:</strong> {{ "{:,}".format(booking.total_payout_vnd or 0) }} VND</p>
    <p><strong>Ph√≤ng ƒë√£ ƒë·∫∑t (<span id="booked-room-name">{{ room_assignment.booked_room }}</span>):</strong>
      <span id="booked-revenue">‚Äî</span> VND
    </p>
    <p><strong>Ph√≤ng th·ª±c t·∫ø (<span id="actual-room-name">{{ room_assignment.actual_room }}</span>):</strong>
      <span id="actual-revenue">‚Äî</span> VND
    </p>
  </div>
</div>
{% endif %}

<script>
  // Simple revenue attribution preview  
  function updateRevenuePreview() {
    const attribution = document.querySelector('[name="revenue_attribution"]').value;
    const totalRevenue = parseInt('{{ booking.total_payout_vnd or 0 }}');
    const bookedSpan = document.getElementById('booked-revenue');
    const actualSpan = document.getElementById('actual-revenue');

    // Update room names in preview
    const bookedSelect = document.querySelector('[name="booked_room"]');
    const actualSelect = document.querySelector('[name="actual_room"]');
    const bookedNameSpan = document.getElementById('booked-room-name');
    const actualNameSpan = document.getElementById('actual-room-name');

    if (bookedSelect && bookedNameSpan) {
      const bookedOption = bookedSelect.options[bookedSelect.selectedIndex];
      bookedNameSpan.textContent = bookedOption.value || '‚Äî';
    }

    if (actualSelect && actualNameSpan) {
      const actualOption = actualSelect.options[actualSelect.selectedIndex];
      actualNameSpan.textContent = actualOption.value || '‚Äî';
    }

    if (!bookedSpan || !actualSpan) return;

    let bookedRevenue = 0;
    let actualRevenue = 0;

    if (attribution === 'booked_room') {
      bookedRevenue = totalRevenue;
    } else if (attribution === 'actual_room') {
      actualRevenue = totalRevenue;
    } else if (attribution === 'split') {
      bookedRevenue = Math.floor(totalRevenue / 2);
      actualRevenue = totalRevenue - bookedRevenue;
    }

    bookedSpan.textContent = bookedRevenue.toLocaleString();
    actualSpan.textContent = actualRevenue.toLocaleString();
  }

  // Update preview on page load and when selection changes
  document.addEventListener('DOMContentLoaded', updateRevenuePreview);
  const attributionSelect = document.querySelector('[name="revenue_attribution"]');
  if (attributionSelect) {
    attributionSelect.addEventListener('change', updateRevenuePreview);
  }

  // Listen to room selection changes
  const bookedRoomSelect = document.querySelector('[name="booked_room"]');
  const actualRoomSelect = document.querySelector('[name="actual_room"]');
  if (bookedRoomSelect) {
    bookedRoomSelect.addEventListener('change', updateRevenuePreview);
  }
  if (actualRoomSelect) {
    actualRoomSelect.addEventListener('change', updateRevenuePreview);
  }
</script>

{% endblock %}