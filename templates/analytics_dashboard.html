<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Airbnb Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }
    </style>
</head>

<body style="background-color: #f8f9fa;">
    <div class="container-fluid py-4">
        <h1 class="mb-4">üìä Analytics Dashboard</h1>

        <!-- Date Filter -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h5>üóìÔ∏è B·ªô l·ªçc th·ªùi gian</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">T·ª´ ng√†y:</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">ƒê·∫øn ng√†y:</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ C·∫≠p nh·∫≠t</button>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-success" onclick="exportDashboard()">üì§ Xu·∫•t d·ªØ li·ªáu</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="row mb-4" id="metricsRow">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalRevenue">-</div>
                    <div class="metric-label">üí∞ T·ªïng doanh thu</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="metric-value" id="totalExpenses">-</div>
                    <div class="metric-label">üí∏ T·ªïng chi ph√≠</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="metric-value" id="netProfit">-</div>
                    <div class="metric-label">üíé L·ª£i nhu·∫≠n r√≤ng</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="metric-value" id="occupancyRate">-</div>
                    <div class="metric-label">üè† T·ª∑ l·ªá l·∫•p ƒë·∫ßy</div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5>üìà Doanh thu vs Chi ph√≠ theo BDS</h5>
                    <div class="chart-container">
                        <canvas id="revenueExpenseChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5>üéØ Top 10 BDS theo Margin</h5>
                    <div class="chart-container">
                        <canvas id="marginChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5>üìä ARPU theo BDS</h5>
                    <div class="chart-container">
                        <canvas id="arpuChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5>üè¢ T·ª∑ l·ªá l·∫•p ƒë·∫ßy theo BDS</h5>
                    <div class="chart-container">
                        <canvas id="occupancyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Trends -->
        <div class="row">
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h5>üìÖ Xu h∆∞·ªõng 12 th√°ng g·∫ßn nh·∫•t</h5>
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row">
            <div class="col-md-12">
                <div class="dashboard-card">
                    <h5>üìã Chi ti·∫øt theo BDS</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="propertyTable">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>T√™n BDS</th>
                                    <th>Doanh thu</th>
                                    <th>Chi ph√≠</th>
                                    <th>L·ª£i nhu·∫≠n</th>
                                    <th>Margin %</th>
                                    <th>ARPU</th>
                                    <th>L·∫•p ƒë·∫ßy %</th>
                                </tr>
                            </thead>
                            <tbody id="propertyTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let dashboardData = null;
        let charts = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            // Set default dates (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];

            // Load initial data
            refreshDashboard();
        });

        async function refreshDashboard() {
            try {
                showLoading();

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                let url = '/api/analytics/dashboard';
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                dashboardData = await response.json();

                updateMetrics();
                updateCharts();
                updatePropertyTable();

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu dashboard: ' + error.message);
            }
        }

        function showLoading() {
            const elements = ['totalRevenue', 'totalExpenses', 'netProfit', 'occupancyRate'];
            elements.forEach(id => {
                document.getElementById(id).textContent = '...';
            });
        }

        function updateMetrics() {
            const revenueData = dashboardData.revenue_vs_expense;
            const occupancyData = dashboardData.occupancy;

            document.getElementById('totalRevenue').textContent = revenueData.summary.formatted.total_revenue;
            document.getElementById('totalExpenses').textContent = revenueData.summary.formatted.total_expenses;
            document.getElementById('netProfit').textContent = revenueData.summary.formatted.net_profit;
            document.getElementById('occupancyRate').textContent = occupancyData.summary.overall_occupancy + '%';
        }

        function updateCharts() {
            updateRevenueExpenseChart();
            updateMarginChart();
            updateArpuChart();
            updateOccupancyChart();
            updateTrendsChart();
        }

        function updateRevenueExpenseChart() {
            const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
            const data = dashboardData.revenue_vs_expense;

            if (charts.revenueExpense) charts.revenueExpense.destroy();

            charts.revenueExpense = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.charts.property_names,
                    datasets: [
                        {
                            label: 'Doanh thu',
                            data: data.charts.revenue_chart,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Chi ph√≠',
                            data: data.charts.expense_chart,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNƒê';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' +
                                        new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNƒê';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMarginChart() {
            const ctx = document.getElementById('marginChart').getContext('2d');
            const data = dashboardData.revenue_vs_expense;

            if (charts.margin) charts.margin.destroy();

            charts.margin = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.charts.property_names,
                    datasets: [{
                        data: data.charts.margin_chart,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateArpuChart() {
            const ctx = document.getElementById('arpuChart').getContext('2d');
            const data = dashboardData.arpu;

            if (charts.arpu) charts.arpu.destroy();

            const propertyNames = data.properties.slice(0, 10).map(p => p.property_name);
            const arpuValues = data.properties.slice(0, 10).map(p => p.arpu);

            charts.arpu = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: propertyNames,
                    datasets: [{
                        label: 'ARPU',
                        data: arpuValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNƒê';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateOccupancyChart() {
            const ctx = document.getElementById('occupancyChart').getContext('2d');
            const data = dashboardData.occupancy;

            if (charts.occupancy) charts.occupancy.destroy();

            const propertyNames = data.properties.slice(0, 10).map(p => p.property_name);
            const occupancyRates = data.properties.slice(0, 10).map(p => p.occupancy_rate);

            charts.occupancy = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: propertyNames,
                    datasets: [{
                        label: 'T·ª∑ l·ªá l·∫•p ƒë·∫ßy (%)',
                        data: occupancyRates,
                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function (value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const data = dashboardData.trends;

            if (charts.trends) charts.trends.destroy();

            charts.trends = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.months,
                    datasets: [
                        {
                            label: 'Doanh thu',
                            data: data.revenue_trend,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Chi ph√≠',
                            data: data.expense_trend,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'L·ª£i nhu·∫≠n',
                            data: data.profit_trend,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return new Intl.NumberFormat('vi-VN').format(value) + ' VNƒê';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' +
                                        new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNƒê';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePropertyTable() {
            const revenueData = dashboardData.revenue_vs_expense.properties;
            const arpuData = dashboardData.arpu.properties;
            const occupancyData = dashboardData.occupancy.properties;

            // Create lookup maps
            const arpuMap = {};
            arpuData.forEach(p => arpuMap[p.property_id] = p.arpu);

            const occupancyMap = {};
            occupancyData.forEach(p => occupancyMap[p.property_id] = p.occupancy_rate);

            const tbody = document.getElementById('propertyTableBody');
            tbody.innerHTML = '';

            revenueData.forEach(property => {
                const row = tbody.insertRow();
                const arpu = arpuMap[property.property_id] || 0;
                const occupancy = occupancyMap[property.property_id] || 0;

                row.innerHTML = `
                    <td>${property.rank}</td>
                    <td>${property.property_name}</td>
                    <td>${property.revenue_formatted}</td>
                    <td>${property.expenses_formatted}</td>
                    <td>${property.profit_formatted}</td>
                    <td>${property.margin}%</td>
                    <td>${new Intl.NumberFormat('vi-VN').format(arpu)} VNƒê</td>
                    <td>${occupancy}%</td>
                `;
            });
        }

        function exportDashboard() {
            if (!dashboardData) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                return;
            }

            const dataStr = JSON.stringify(dashboardData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `analytics_dashboard_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>