#!/bin/bash
# ðŸš€ CREATE BRAIN FROM TEMPLATE - Bash Script  
# Má»¥c tiÃªu: Setup brain system tá»« template trong < 5 phÃºt

# Colors cho output
RED='\033[0;31m'
GREEN='\033[0;32m' 
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

success() { echo -e "${GREEN}âœ… $1${NC}"; }
warning() { echo -e "${YELLOW}âš ï¸ $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; }
info() { echo -e "${CYAN}â„¹ï¸ $1${NC}"; }

# Parse arguments
PROJECT_NAME=""
TEAM="Development Team"
DOMAIN="SaaS"
TARGET_PATH=".brain"

while [[ $# -gt 0 ]]; do
    case $1 in
        --project-name)
            PROJECT_NAME="$2"
            shift 2
            ;;
        --team)
            TEAM="$2"
            shift 2
            ;;
        --domain)
            DOMAIN="$2"
            shift 2
            ;;
        --target-path)
            TARGET_PATH="$2"
            shift 2
            ;;
        *)
            error "Unknown parameter: $1"
            echo "Usage: $0 --project-name NAME [--team TEAM] [--domain DOMAIN] [--target-path PATH]"
            exit 1
            ;;
    esac
done

if [ -z "$PROJECT_NAME" ]; then
    error "Project name is required!"
    echo "Usage: $0 --project-name NAME [--team TEAM] [--domain DOMAIN]"
    exit 1
fi

info "ðŸš€ Báº®T Äáº¦U SETUP BRAIN SYSTEM CHO Dá»° ÃN: $PROJECT_NAME"
START_TIME=$(date +%s)
info "â±ï¸ Thá»i gian báº¯t Ä‘áº§u: $(date)"

# Kiá»ƒm tra PROJECT_TEMPLATE
TEMPLATE_PATH=".brain/PROJECT_TEMPLATE"
if [ ! -d "$TEMPLATE_PATH" ]; then
    error "KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c $TEMPLATE_PATH"
    info "HÃ£y Ä‘áº£m báº£o báº¡n Ä‘ang cháº¡y script tá»« root directory cá»§a dá»± Ã¡n"
    exit 1
fi

success "TÃ¬m tháº¥y template directory: $TEMPLATE_PATH"

# Táº¡o thÆ° má»¥c Ä‘Ã­ch
mkdir -p "$TARGET_PATH/tasks" "$TARGET_PATH/context" "$TARGET_PATH/logs/daily"
success "ÄÃ£ táº¡o cáº¥u trÃºc thÆ° má»¥c brain system"

# Copy vÃ  rename template files
declare -A TEMPLATE_FILES=(
    ["TEMPLATE_SCOPE.md"]="SCOPE.md"
    ["TEMPLATE_DOMAIN_MAP.md"]="DOMAIN_MAP.md"
    ["SAMPLE_ACTIVE_TASKS.json"]="tasks/ACTIVE_TASKS.json"
    ["QUICK_START.md"]="QUICK_START.md"
    ["SETUP_GUIDE.md"]="SETUP_GUIDE.md"
    ["INDEX.md"]="README.md"
)

info "ðŸ“ Äang copy vÃ  rename template files..."
COPIED_FILES=()

for source_file in "${!TEMPLATE_FILES[@]}"; do
    dest_file="${TEMPLATE_FILES[$source_file]}"
    source_path="$TEMPLATE_PATH/$source_file"
    dest_path="$TARGET_PATH/$dest_file"
    
    if [ -f "$source_path" ]; then
        cp "$source_path" "$dest_path"
        COPIED_FILES+=("$dest_path")
        success "Copied: $source_file â†’ $dest_file"
    else
        warning "KhÃ´ng tÃ¬m tháº¥y: $source_file"
    fi
done

# Thay tháº¿ placeholders
CURRENT_DATE=$(date +%Y-%m-%d)
CURRENT_DATETIME=$(date +"%Y-%m-%d %H:%M")

declare -A PLACEHOLDERS=(
    ["{{PROJECT_NAME}}"]="$PROJECT_NAME"
    ["{{TEAM_NAME}}"]="$TEAM"
    ["{{DOMAIN}}"]="$DOMAIN"
    ["{{CURRENT_DATE}}"]="$CURRENT_DATE"
    ["{{LAST_UPDATED}}"]="$CURRENT_DATE"
    ["{{LAST_UPDATE_DATE}}"]="$CURRENT_DATETIME"
    ["{{VERSION}}"]="1.0.0"
    ["{{STATUS}}"]="Development"
    ["{{CREATION_DATE}}"]="$CURRENT_DATE"
)

info "ðŸ”„ Äang thay tháº¿ placeholders trong cÃ¡c file..."
REPLACED_COUNT=0

for file_path in "${COPIED_FILES[@]}"; do
    if [ -f "$file_path" ]; then
        temp_file=$(mktemp)
        cp "$file_path" "$temp_file"
        
        for placeholder in "${!PLACEHOLDERS[@]}"; do
            replacement="${PLACEHOLDERS[$placeholder]}"
            sed -i.bak "s|${placeholder}|${replacement}|g" "$file_path"
        done
        
        # Check if file was modified
        if ! diff -q "$temp_file" "$file_path" > /dev/null 2>&1; then
            ((REPLACED_COUNT++))
            success "Updated placeholders in: $(basename "$file_path")"
        fi
        
        rm "$temp_file" "$file_path.bak" 2>/dev/null
    fi
done

# Táº¡o CONTEXT_INDEX.md
CONTEXT_INDEX_PATH="$TARGET_PATH/context/CONTEXT_INDEX.md"
cat > "$CONTEXT_INDEX_PATH" << EOF
# ðŸ“‹ CONTEXT INDEX - $PROJECT_NAME

> **Domain**: $DOMAIN | **Team**: $TEAM | **Created**: $CURRENT_DATE

## ðŸŽ¯ **PROJECT OVERVIEW**
Dá»± Ã¡n **$PROJECT_NAME** trong domain **$DOMAIN** Ä‘Æ°á»£c táº¡o tá»« brain template system.

## ðŸ“‚ **CONTEXT FILES**
- **SCOPE.md**: Project scope definition vÃ  goals
- **DOMAIN_MAP.md**: Domain entities vÃ  workflows  
- **tasks/ACTIVE_TASKS.json**: Current active tasks tracking

## ðŸš€ **QUICK START**
1. Review SCOPE.md Ä‘á»ƒ hiá»ƒu project goals
2. Check tasks/ACTIVE_TASKS.json cho current tasks
3. Update DOMAIN_MAP.md vá»›i domain-specific info

---
*Auto-generated by create-brain-from-template.sh*
*Created: $CURRENT_DATETIME*
EOF

success "Táº¡o context index: context/CONTEXT_INDEX.md"

# Táº¡o daily log
TODAY_LOG="$TARGET_PATH/logs/daily/$CURRENT_DATE.md"
cat > "$TODAY_LOG" << EOF
# ðŸ“… Daily Log - $CURRENT_DATE

## ðŸš€ **PROJECT SETUP**
- **Time**: $CURRENT_DATETIME
- **Project**: $PROJECT_NAME
- **Domain**: $DOMAIN
- **Team**: $TEAM

## âœ… **COMPLETED**
- Brain system Ä‘Æ°á»£c setup tá»« template
- Template files Ä‘Æ°á»£c copy vÃ  customize  
- Placeholders Ä‘Æ°á»£c thay tháº¿ tá»± Ä‘á»™ng

## ðŸ“ **NEXT ACTIONS**
- Review SCOPE.md vÃ  update goals if needed
- Add specific tasks vÃ o ACTIVE_TASKS.json
- Customize DOMAIN_MAP.md vá»›i domain entities

---
*Auto-generated by brain template system*
EOF

success "Táº¡o daily log: logs/daily/$CURRENT_DATE.md"

# TÃ­nh thá»i gian
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

info ""
info "ðŸŽ‰ HOÃ€N THÃ€NH SETUP BRAIN SYSTEM!"
info "â±ï¸ Thá»i gian setup: ${DURATION} giÃ¢y"
info "ðŸ“ Files Ä‘Æ°á»£c táº¡o: $((${#COPIED_FILES[@]} + 2))"
info "ðŸ”„ Placeholders Ä‘Æ°á»£c thay: $REPLACED_COUNT files"

info ""
info "ðŸ“‹ **NEXT STEPS**:"
info "1. Review file SCOPE.md"
info "2. Update tasks/ACTIVE_TASKS.json vá»›i initial tasks"
info "3. Customize DOMAIN_MAP.md náº¿u cáº§n"  
info "4. Cháº¡y validate-brain-template.sh Ä‘á»ƒ check"

info ""
success "ðŸ§  Brain system Ä‘Ã£ sáºµn sÃ ng cho dá»± Ã¡n $PROJECT_NAME!"